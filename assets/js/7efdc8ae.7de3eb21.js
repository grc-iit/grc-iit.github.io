"use strict";(self.webpackChunkgrc=self.webpackChunkgrc||[]).push([[90342],{39842:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>d,default:()=>c,frontMatter:()=>r,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"hermes/components/distributed-metadata","title":"Distributed Metadata","description":"Metadata is stored in a distributed hash map. In each Hermes Daemon, we","source":"@site/docs/12-hermes/08-components/08-distributed-metadata.md","sourceDirName":"12-hermes/08-components","slug":"/hermes/components/distributed-metadata","permalink":"/docs/hermes/components/distributed-metadata","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":8,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Runtime","permalink":"/docs/hermes/components/runtime"},"next":{"title":"Prefetcher","permalink":"/docs/hermes/components/prefetcher"}}');var i=n(74848),a=n(28453);const r={},d="Distributed Metadata",o={},l=[{value:"User View",id:"user-view",level:2},{value:"System View",id:"system-view",level:2},{value:"UniqueId",id:"uniqueid",level:2},{value:"Storage Method",id:"storage-method",level:2},{value:"Maps and ID Lists",id:"maps-and-id-lists",level:2},{value:"Pros",id:"pros",level:3},{value:"Cons",id:"cons",level:3},{value:"Walkthrough of <code>Bucket.Put()</code>",id:"walkthrough-of-bucketput",level:2},{value:"Walkthrough of <code>Bucket.Get()</code>",id:"walkthrough-of-bucketget",level:2},{value:"Limits",id:"limits",level:2}];function h(e){const t={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"distributed-metadata",children:"Distributed Metadata"})}),"\n",(0,i.jsxs)(t.p,{children:["Metadata is stored in a distributed hash map. In each Hermes Daemon, we\ninitialize an ",(0,i.jsx)(t.code,{children:"hipc::unordered_map"}),". The main metadata structures we store\nare as follows: Tag Map (note, Buckets are represented as Tags), Blob Map,\nand Trait Map. These maps typically map an integer ID to an\ninformation structure. For example, the Blob Map maps a ",(0,i.jsx)(t.code,{children:"BlobId"})," (a 96-bit int)\nto a ",(0,i.jsx)(t.code,{children:"BlobInfo"})," struct. In addition, we have separate maps for mapping semantic\nstrings to integer IDs. For example, we have a map from a ",(0,i.jsx)(t.code,{children:"hipc::string"})," to\na ",(0,i.jsx)(t.code,{children:"BlobId"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"At this time, metadata is not replicated on nodes and we assume that metadata\ndoesn't grow so large that it exceeds the bounds of main memory."}),"\n",(0,i.jsx)(t.h2,{id:"user-view",children:"User View"}),"\n",(0,i.jsx)(t.p,{children:"Metadata (e.g., Blobs and Tags) can be given semantic names using hipc::strings\nor std::strings. hipc::string is what is eventually stored in Hermes, since it's\ncompatible with shared memory."}),"\n",(0,i.jsx)(t.h2,{id:"system-view",children:"System View"}),"\n",(0,i.jsx)(t.p,{children:"User primitives are referred to by unsigned 96-bit integers (IDs)."}),"\n",(0,i.jsx)(t.p,{children:"Each ID encodes the data it needs to access its metadata."}),"\n",(0,i.jsx)(t.h2,{id:"uniqueid",children:"UniqueId"}),"\n",(0,i.jsx)(t.p,{children:"TagIds, BlobIds, and TraitIds all are instances of a UniqueId. UniqueIds are\nrepresented as follows:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Node ID: The identifier of the node the metadata is on (32-bit)"}),"\n",(0,i.jsx)(t.li,{children:"Unique: The unique number of the metadata object (64-bit)"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"The unique field is a 64-bit integer which is atomically incremented every time\nthe program creates a new metadata object. 64-bit is large enough that the\nprogram should never be able to use all 2^64 combos."}),"\n",(0,i.jsx)(t.h2,{id:"storage-method",children:"Storage Method"}),"\n",(0,i.jsx)(t.h2,{id:"maps-and-id-lists",children:"Maps and ID Lists"}),"\n",(0,i.jsx)(t.p,{children:"All metadata is distributed among nodes by first hashing the key to\ndetermine the node, then hashing again to determine the slot."}),"\n",(0,i.jsx)(t.h3,{id:"pros",children:"Pros"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Better load balancing"}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"cons",children:"Cons"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["May require extra RPC calls. Initial tests show that this\nindirection should be avoided. ",(0,i.jsx)(t.strong,{children:"TODO:"})," We need to revisit this."]}),"\n"]}),"\n",(0,i.jsxs)(t.h2,{id:"walkthrough-of-bucketput",children:["Walkthrough of ",(0,i.jsx)(t.code,{children:"Bucket.Put()"})]}),"\n",(0,i.jsxs)(t.p,{children:["1. Create a new ",(0,i.jsx)(t.code,{children:"BlobID"}),". The ID's node index (top 32 bits) is created\nby hashing the blob name, and the ID's offset to a list of ",(0,i.jsx)(t.code,{children:"BufferID"}),"s\n(bottom 32 bits) is allocated from the MDM shared memory segment on the\ntarget node."]}),"\n",(0,i.jsxs)(t.p,{children:["2. Add the new ",(0,i.jsx)(t.code,{children:"BlobID"})," to the ",(0,i.jsx)(t.strong,{children:"IdMap"}),". This could be local, or an\nRPC."]}),"\n",(0,i.jsxs)(t.p,{children:["3. Add the ",(0,i.jsx)(t.code,{children:"BlobID"})," to the ",(0,i.jsx)(t.code,{children:"Bucket"}),"'s list of blobs."]}),"\n",(0,i.jsxs)(t.h2,{id:"walkthrough-of-bucketget",children:["Walkthrough of ",(0,i.jsx)(t.code,{children:"Bucket.Get()"})]}),"\n",(0,i.jsxs)(t.p,{children:["1. Hash the blob name to get the ",(0,i.jsx)(t.code,{children:"BlobID"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["2. Get the list of ",(0,i.jsx)(t.code,{children:"BufferID"}),"s from the ",(0,i.jsx)(t.code,{children:"BlobID"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["3. Read each ",(0,i.jsx)(t.code,{children:"BufferID"}),"'s data into a user buffer."]}),"\n",(0,i.jsx)(t.h2,{id:"limits",children:"Limits"}),"\n",(0,i.jsx)(t.p,{children:"There can be a total of 2^64 unique metadata objects. I.e., there can be\na total of 2^64 Tags, Buckets, and Traits."})]})}function c(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>d});var s=n(96540);const i={},a=s.createContext(i);function r(e){const t=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(a.Provider,{value:t},e.children)}}}]);