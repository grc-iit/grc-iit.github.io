"use strict";(self.webpackChunkgrc=self.webpackChunkgrc||[]).push([[26125],{2478:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>t,default:()=>d,frontMatter:()=>l,metadata:()=>s,toc:()=>h});const s=JSON.parse('{"id":"hermes/deploying-hermes","title":"Deploying Hermes","description":"Configuring + Deploying Hermes","source":"@site/docs/12-hermes/03-deploying-hermes.md","sourceDirName":"12-hermes","slug":"/hermes/deploying-hermes","permalink":"/docs/hermes/deploying-hermes","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Building Hermes","permalink":"/docs/hermes/building-hermes"},"next":{"title":"Configuration","permalink":"/docs/hermes/configuration"}}');var a=i(74848),r=i(28453);const l={},t="Deploying Hermes",o={},h=[{value:"Configuring + Deploying Hermes",id:"configuring--deploying-hermes",level:2},{value:"Building the Jarvis Configuration",id:"building-the-jarvis-configuration",level:2},{value:"Bootstrapping for a single-node machine",id:"bootstrapping-for-a-single-node-machine",level:3},{value:"Bootstrapping from a specific machine",id:"bootstrapping-from-a-specific-machine",level:3},{value:"Creating a new configuration",id:"creating-a-new-configuration",level:3},{value:"Set the active Hostfile",id:"set-the-active-hostfile",level:2},{value:"Building the Resource Graph",id:"building-the-resource-graph",level:2},{value:"Building an Environment",id:"building-an-environment",level:2},{value:"Create a pipeline",id:"create-a-pipeline",level:2},{value:"Copy the environment cache",id:"copy-the-environment-cache",level:3},{value:"Add Hermes runtime",id:"add-hermes-runtime",level:3},{value:"Starting + Stopping Hermes",id:"starting--stopping-hermes",level:3},{value:"Stopping and Killing Hermes",id:"stopping-and-killing-hermes",level:3},{value:"Cleanup",id:"cleanup",level:3},{value:"Changing the active Hostfile",id:"changing-the-active-hostfile",level:2},{value:"Configuring + Deploying Hermes with an Application",id:"configuring--deploying-hermes-with-an-application",level:2},{value:"Build an Environment",id:"build-an-environment",level:3},{value:"Create an empty pipeline",id:"create-an-empty-pipeline",level:3},{value:"Copy the environment cache",id:"copy-the-environment-cache-1",level:3},{value:"Set the active hostfile",id:"set-the-active-hostfile-1",level:3},{value:"Add Hermes runtime",id:"add-hermes-runtime-1",level:3},{value:"Add Hermes MPI-IO interceptor",id:"add-hermes-mpi-io-interceptor",level:3},{value:"Add IOR",id:"add-ior",level:3},{value:"Run the Pipeline",id:"run-the-pipeline",level:3},{value:"Cleanup",id:"cleanup-1",level:3},{value:"Why is my application hanging?",id:"why-is-my-application-hanging",level:2},{value:"Resource Graph Misconfiguration",id:"resource-graph-misconfiguration",level:3},{value:"Dependency Problems",id:"dependency-problems",level:3},{value:"Machine Misconfiguration",id:"machine-misconfiguration",level:3},{value:"Permissions Problems",id:"permissions-problems",level:3}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"deploying-hermes",children:"Deploying Hermes"})}),"\n",(0,a.jsx)(n.h2,{id:"configuring--deploying-hermes",children:"Configuring + Deploying Hermes"}),"\n",(0,a.jsxs)(n.p,{children:["The Hermes daemon is responsible for tracking various metadata, and it is\nrequired to be launched before your application. There should only be\none Hermes daemon per node. We recommend\n",(0,a.jsx)(n.a,{href:"https://github.com/grc-iit/jarvis-cd.git",children:"Jarvis"})," for deploying Hermes.\nJarvis is a framework that configures and deploys complex applications and\nservices. Jarvis will automatically set various environment variables\nthat Hermes expects in order for applications to be deployed. We have\nalso integrated several applications into Jarvis that can be seamlessly\ndeployed with Hermes."]}),"\n",(0,a.jsx)(n.p,{children:"Jarvis is automatically installed as a dependency in GRC's spack repo."}),"\n",(0,a.jsx)(n.h2,{id:"building-the-jarvis-configuration",children:"Building the Jarvis Configuration"}),"\n",(0,a.jsx)(n.h3,{id:"bootstrapping-for-a-single-node-machine",children:"Bootstrapping for a single-node machine"}),"\n",(0,a.jsx)(n.p,{children:"You may be trying to test things on just a single node."}),"\n",(0,a.jsx)(n.p,{children:"In this case, run:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis bootstrap from local\n"})}),"\n",(0,a.jsx)(n.h3,{id:"bootstrapping-from-a-specific-machine",children:"Bootstrapping from a specific machine"}),"\n",(0,a.jsx)(n.p,{children:"Jarvis has been pre-configured on some machines. To bootstrap from\none of them, run the following:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis bootstrap from ares\n"})}),"\n",(0,a.jsx)(n.p,{children:"NOTE: Jarvis must be installed from the compute nodes in Ares, NOT the master node. This is because we store configuration data in /mnt/ssd by default, which is only on compute nodes. We do not store data in /tmp since it will be eventually destroyed."}),"\n",(0,a.jsx)(n.p,{children:"To check the set of available machines to bootstrap from, run:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis bootstrap list\n"})}),"\n",(0,a.jsx)(n.h3,{id:"creating-a-new-configuration",children:"Creating a new configuration"}),"\n",(0,a.jsx)(n.p,{children:"A configuration can be generated as follows:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis init [CONFIG_DIR] [PRIVATE_DIR] [SHARED_DIR]\n"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"CONFIG_DIR:"})," A directory where jarvis metadata for pkgs and pipelines\nare stored. This directory can be anywhere that the current user can access."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"PRIVATE_DIR:"})," A directory which is common across all machines, but\nstores data locally to the machine. Some jarvis pkgs require certain data to\nbe stored per-machine. OrangeFS is an example."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"SHARED_DIR:"})," A directory which is common across all machines, where\neach machine has the same view of data in the directory. Most jarvis pkgs\nrequire this, but on machines without a global filesystem (e.g., Chameleon Cloud),\nthis parameter can be set later."]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"For a personal machine, these directories can be the same directory."}),"\n",(0,a.jsx)(n.p,{children:"In addition to initializing the jarvis conf file, you must also build a resource graph."}),"\n",(0,a.jsx)(n.h2,{id:"set-the-active-hostfile",children:"Set the active Hostfile"}),"\n",(0,a.jsx)(n.p,{children:"The hostfile contains the set of nodes that the pipeline will run over.\nThis is structured the same way as a traditional MPI hostfile."}),"\n",(0,a.jsx)(n.p,{children:"An example hostfile:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-txt",children:"ares-comp-20\nares-comp-[21-25]\n"})}),"\n",(0,a.jsx)(n.p,{children:"To set the active hostfile, run:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis hostfile set /path/to/hostfile\n"})}),"\n",(0,a.jsx)(n.p,{children:"Note that every time you change the hostfile, you will need to update the\npipeline. Jarvis does not automatically detect changes to this file."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl update\n"})}),"\n",(0,a.jsx)(n.h2,{id:"building-the-resource-graph",children:"Building the Resource Graph"}),"\n",(0,a.jsxs)(n.p,{children:["NOTE: This step only needs to be run if you did ",(0,a.jsx)(n.code,{children:"jarvis bootstrap from local"})," or ",(0,a.jsx)(n.code,{children:"jarvis init"}),".\nIf you bootstrap from a specific machine, then skip this section."]}),"\n",(0,a.jsx)(n.p,{children:"The resource graph is a snapshot of your systems network and storage.\nMany packages depend on it for their configurations. The Hermes I/O system, for example,\nuses this to identify valid networks and buffering locations."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis rg build\n"})}),"\n",(0,a.jsx)(n.p,{children:"This command should be executed on a subset of nodes on your machine that you plan to\nrun tests on. If the machines are similar, two nodes should be enough."}),"\n",(0,a.jsx)(n.h2,{id:"building-an-environment",children:"Building an Environment"}),"\n",(0,a.jsx)(n.p,{children:"We will now load all necessary environment variables and build a\nJarvis environment named hermes_env:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"spack load hermes\njarvis env build hermes_env\n"})}),"\n",(0,a.jsx)(n.p,{children:"hermes_env will store all important environment variables, including PATH,\nLD_LIBRARY_PATH, etc. in a YAML file. This will make it so that you do not\nneed to repeatedly run spack load and module load if the machine is broken."}),"\n",(0,a.jsx)(n.h2,{id:"create-a-pipeline",children:"Create a pipeline"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl create hermes\n"})}),"\n",(0,a.jsx)(n.p,{children:"hermes is the name of the pipeline. It doesn't need to be hermes,\nit can be any name."}),"\n",(0,a.jsx)(n.h3,{id:"copy-the-environment-cache",children:"Copy the environment cache"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl env copy hermes_env\n"})}),"\n",(0,a.jsx)(n.p,{children:"This will use the hermes_env environment that was previously created in"}),"\n",(0,a.jsx)(n.h3,{id:"add-hermes-runtime",children:"Add Hermes runtime"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl append hermes_run\njarvis pkg configure hermes_run \\\nsleep=5 \\\ninclude=${HOME}/ior_data\n"})}),"\n",(0,a.jsx)(n.p,{children:"Jarvis will automatically produce a Hermes client and server configuration that\ncontains all storage devices and fastest available network defined in the\nresource graph. These configurations will be located in:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$(jarvis path +shared)/hermes_run/hermes_server.yaml\n$(jarvis path +shared)/hermes_run/hermes_client.yaml\n"})}),"\n",(0,a.jsx)(n.p,{children:"To view all parameters of the Hermes package, you can run:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis pkg help hermes_run\n"})}),"\n",(0,a.jsx)(n.h3,{id:"starting--stopping-hermes",children:"Starting + Stopping Hermes"}),"\n",(0,a.jsx)(n.p,{children:"To start Hermes:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl start\n"})}),"\n",(0,a.jsx)(n.h3,{id:"stopping-and-killing-hermes",children:"Stopping and Killing Hermes"}),"\n",(0,a.jsx)(n.p,{children:"To gracefully stop Hermes and flush data back to the PFS:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl stop\n"})}),"\n",(0,a.jsx)(n.p,{children:"To kill a Hermes deployment that isn't stopping gracefully:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl kill\n"})}),"\n",(0,a.jsx)(n.h3,{id:"cleanup",children:"Cleanup"}),"\n",(0,a.jsx)(n.p,{children:"To erase data produced by the pipeline:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl clean\n"})}),"\n",(0,a.jsx)(n.p,{children:"To destroy the pipeline:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl destroy\n"})}),"\n",(0,a.jsx)(n.h2,{id:"changing-the-active-hostfile",children:"Changing the active Hostfile"}),"\n",(0,a.jsx)(n.p,{children:"You may want to change the hostfile at some point. This can\nbe done using the same command as before."}),"\n",(0,a.jsx)(n.p,{children:"However, note that every time you change the hostfile, you will need to update the\npipeline. Jarvis does not automatically detect changes to this file."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl update\n"})}),"\n",(0,a.jsx)(n.h2,{id:"configuring--deploying-hermes-with-an-application",children:"Configuring + Deploying Hermes with an Application"}),"\n",(0,a.jsx)(n.p,{children:"As previously stated, Jarvis can be used to deploy and application\nwith Hermes. This will automatically set environment variables\n(e.g., LD_PRELOAD) that will be necessary for the application to\nrun."}),"\n",(0,a.jsx)(n.h3,{id:"build-an-environment",children:"Build an Environment"}),"\n",(0,a.jsx)(n.p,{children:"We will now load all necessary environment variables and build a\nJarvis environment named hermes_env:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"spack load hermes\nspack load ior\njarvis env build hermes_ior_env\n"})}),"\n",(0,a.jsx)(n.p,{children:"hermes_ior_env will store all important environment variables, including PATH,\nLD_LIBRARY_PATH, etc. in a YAML file."}),"\n",(0,a.jsx)(n.h3,{id:"create-an-empty-pipeline",children:"Create an empty pipeline"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl create hermes_ior\n"})}),"\n",(0,a.jsx)(n.h3,{id:"copy-the-environment-cache-1",children:"Copy the environment cache"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl env copy hermes_ior_env\n"})}),"\n",(0,a.jsx)(n.h3,{id:"set-the-active-hostfile-1",children:"Set the active hostfile"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis hostfile set /path/to/hostfile\n"})}),"\n",(0,a.jsx)(n.h3,{id:"add-hermes-runtime-1",children:"Add Hermes runtime"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl append hermes_run\njarvis pkg configure hermes_run \\\nsleep=5 \\\ninclude=${HOME}/ior_data\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This will ensure that if a Hermes interceptor is used, it will intercept\nall paths in ",(0,a.jsx)(n.code,{children:"${HOME}/ior_data"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"add-hermes-mpi-io-interceptor",children:"Add Hermes MPI-IO interceptor"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl append hermes_api +mpi\n"})}),"\n",(0,a.jsx)(n.p,{children:"This will automatically locate the interceptor library by\ntraversing various environment variables. This will ensure\nthat MPI-IO is intercepted by Hermes."}),"\n",(0,a.jsx)(n.p,{children:"hermes_api includes other interceptors that can be used: posix, stdio, vfd. To view the set of options:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis pkg help hermes_run\n"})}),"\n",(0,a.jsx)(n.h3,{id:"add-ior",children:"Add IOR"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl append ior\njarvis pkg configure ior \\\nxfer=1m \\\nblock=1g \\\nnprocs=64 \\\nppn=16 \\\n+write +read \\\nout=${HOME}/ior_data/ior.bin \\\napi=mpiio\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This IOR will perform 1GB of I/O per-process (block) in units of 1m (xfer) and\nproduce a single output file ",(0,a.jsx)(n.code,{children:"${HOME}/ior_data/ior.bin"}),"(out) using MPI-IO\n(api). The total amount of I/O performed will be 64GB spread across 4 nodes."]}),"\n",(0,a.jsx)(n.h3,{id:"run-the-pipeline",children:"Run the Pipeline"}),"\n",(0,a.jsx)(n.p,{children:"To run the pipeline:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl run\n"})}),"\n",(0,a.jsx)(n.p,{children:"This will launch Hermes, execute IOR, and then stop Hermes. It is equivalent\nto:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl start\njarvis ppl stop\n"})}),"\n",(0,a.jsx)(n.h3,{id:"cleanup-1",children:"Cleanup"}),"\n",(0,a.jsx)(n.p,{children:"The following will delete intermediate data generated by Hermes + IOR:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"jarvis ppl clean\n"})}),"\n",(0,a.jsx)(n.h2,{id:"why-is-my-application-hanging",children:"Why is my application hanging?"}),"\n",(0,a.jsx)(n.h3,{id:"resource-graph-misconfiguration",children:"Resource Graph Misconfiguration"}),"\n",(0,a.jsxs)(n.p,{children:["Commonly, the cause is a misconfiguration in the resource graph, specifically\nwith the network section. If the resource graph is misconfigured, Hermes may\ncrash with a ",(0,a.jsx)(n.code,{children:"mercury->fatal"})," error and ultimately cause the program to stall\nforever. Make sure that the domain, provider, and fabric are valid. To view the\nHermes configuration to see which network was selected from your resource graph,\nyou can run:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"cat $(jarvis path)/hermes_run/hermes_server.yaml\n"})}),"\n",(0,a.jsx)(n.h3,{id:"dependency-problems",children:"Dependency Problems"}),"\n",(0,a.jsx)(n.p,{children:"If you are using the MPI-IO interceptor, make sure that the MPI that Hermes\ncompiled with is equivalent to the one your application was compiled with.\nYou may have multiple versions of MPI installed and if you didn't specify\nwhich one when installing Hermes and your program -- they may be different."}),"\n",(0,a.jsx)(n.p,{children:"If you are using the VFD, make sure the VFD was compiled with the same HDF5\nas the application."}),"\n",(0,a.jsx)(n.p,{children:"To view the dependencies of your installed Hermes, run:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"spack find -c -d hermes\n"})}),"\n",(0,a.jsx)(n.h3,{id:"machine-misconfiguration",children:"Machine Misconfiguration"}),"\n",(0,a.jsx)(n.p,{children:"We have found certain instances where using semantic hostnames in the hostfile\nhas resulted in incorrect behavior. If the machine is misconfigured, it is\npossible that a hostname maps to a different network domain on different nodes.\nTo verify this, you can try using exact IP addresses in your hostfile."}),"\n",(0,a.jsxs)(n.p,{children:["To view your machine's IP addresses, you can run\n",(0,a.jsx)(n.code,{children:"ip addr show"})," or ",(0,a.jsx)(n.code,{children:"fi_info | grep fabric"})]}),"\n",(0,a.jsx)(n.h3,{id:"permissions-problems",children:"Permissions Problems"}),"\n",(0,a.jsx)(n.p,{children:"If you cannot SSH between machines or if your known_hosts file is outdated,\nit is possible that Hermes will fail to launch due to permissions problems\non the network. Make sure that you can SSH between machines without error."})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>t});var s=i(96540);const a={},r=s.createContext(a);function l(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);