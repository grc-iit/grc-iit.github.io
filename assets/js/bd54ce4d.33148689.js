"use strict";(self.webpackChunkgrc=self.webpackChunkgrc||[]).push([[3622],{22500:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"hpc-tutorials/cpp-introduction/cpp-build-manually","title":"Building C++ Code Manually","description":"In this section, we have five objectives:","source":"@site/docs/02-hpc-tutorials/04-cpp-introduction/02-cpp-build-manually.mdx","sourceDirName":"02-hpc-tutorials/04-cpp-introduction","slug":"/hpc-tutorials/cpp-introduction/cpp-build-manually","permalink":"/docs/hpc-tutorials/cpp-introduction/cpp-build-manually","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Hello World","permalink":"/docs/hpc-tutorials/cpp-introduction/cpp-hello-world"},"next":{"title":"Building C++ with CMake","permalink":"/docs/hpc-tutorials/cpp-introduction/cpp-build-with-cmake"}}');var r=a(74848),t=a(28453),s=a(26543);const l={},o="Building C++ Code Manually",c={},d=[{value:"Setup",id:"setup",level:2},...s.RM,{value:"Repo Structure",id:"repo-structure",level:2},{value:"Database Library Header",id:"database-library-header",level:2},{value:"Database Library Source",id:"database-library-source",level:2},{value:"Grocery Database Source",id:"grocery-database-source",level:2},{value:"Movies Database Source",id:"movies-database-source",level:2},{value:"C++ Compiler Pipeline",id:"c-compiler-pipeline",level:2},{value:"The Build Directory",id:"the-build-directory",level:2},{value:"Compile + Assemble database_lib.cc",id:"compile--assemble-database_libcc",level:2},{value:"Fix 1: The -I flag",id:"fix-1-the--i-flag",level:3},{value:"Fix 2: Environment Variables",id:"fix-2-environment-variables",level:3},{value:"Link database_lib.o",id:"link-database_libo",level:2},{value:"Create the Executables",id:"create-the-executables",level:2},{value:"Fix 1: The -L flag",id:"fix-1-the--l-flag",level:3},{value:"Fix 2: Environment Variables",id:"fix-2-environment-variables-1",level:3},{value:"Run the Executable",id:"run-the-executable",level:2}];function u(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"building-c-code-manually",children:"Building C++ Code Manually"})}),"\n",(0,r.jsx)(n.p,{children:"In this section, we have five objectives:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"How to compile a program into a shared object"}),"\n",(0,r.jsx)(n.li,{children:"How to compile a program into an executable"}),"\n",(0,r.jsx)(n.li,{children:"How to link a shared object to an executable"}),"\n",(0,r.jsx)(n.li,{children:"How to run an executable which relies on a shared object"}),"\n",(0,r.jsx)(n.li,{children:"How to tell the compiler to optimize code"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["An ",(0,r.jsx)(n.strong,{children:"executable"})," is a piece of code that can be run in a terminal to produce\nsome sort of output. A ",(0,r.jsx)(n.strong,{children:"shared object"})," is code that an executable relies on,\nbut in and of itself is not executable. Shared objects are the primary way that\nC++ enables software to be re-used across code bases and avoid code duplication."]}),"\n",(0,r.jsx)(n.p,{children:"Imagine you have two services:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"A movie database which tracks information such as movie description,\nuser reviews, critic reviews, actors, etc."}),"\n",(0,r.jsx)(n.li,{children:"A grocery database which tracks information such as product name,\nproduct description, quantity available, price, etc."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Both services are databases. Databases provide a few general functions: creating\nrecords, reading records, updating records, and deleting records (CRUD). As\nopposed to developing entire database management systems for these two use\ncases, one could develop a single generic database technology, and then build\nthe movie and grocery databases using that single technology."}),"\n",(0,r.jsx)(n.p,{children:"In C++, this can be done using a shared library. In our example:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"src/database_lib.cc implements the Create, Read, Update, Delete (CRUD) operations."}),"\n",(0,r.jsx)(n.li,{children:"src/grocery_db.cc implements the grocery database using CRUD operations"}),"\n",(0,r.jsx)(n.li,{children:"src/movies_db.cc implements the movie database using CRUD operations"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n","\n",(0,r.jsx)(s.Ay,{}),"\n",(0,r.jsx)(n.p,{children:"Go to the tutorial:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd grc-tutorial\nexport GRC_TUTORIAL=${PWD}\ncd ${GRC_TUTORIAL}/cpp/02-cpp-build-manually\n"})}),"\n",(0,r.jsx)(n.h2,{id:"repo-structure",children:"Repo Structure"}),"\n",(0,r.jsx)(n.p,{children:"In this example, our repo is structured as follows:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"src: contains all source files"}),"\n",(0,r.jsx)(n.li,{children:"include: contains all header files"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This is the typical way a C++ repo is structured. This is because in many cases\nheader files are meant to be public and available to other programs, whereas\nsource files are almost always private. Having them in separate directories\nmakes accomplishing these two objectives much easier."}),"\n",(0,r.jsx)(n.h2,{id:"database-library-header",children:"Database Library Header"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"#ifndef DATABASE_LIB_H\n#define DATABASE_LIB_H\n\n#include <string>\n\nclass Database {\n public:\n  std::string file_;\n\n  Database(const std::string &file) : file_(file) {}\n\n  void create();\n  void read();\n  void update();\n  void del();\n};\n\n#endif\n"})}),"\n",(0,r.jsx)(n.p,{children:"The header file defines the Database class. The class contains the CRUD\nmethods. The methods aren't implemented here in this case. Their implementation\nis in the source file."}),"\n",(0,r.jsx)(n.h2,{id:"database-library-source",children:"Database Library Source"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:'#include <iostream>\n#include "database_lib.h"\n\nvoid Database::create() {\n  std::cout << file_ << ": in create" << std::endl;\n}\n\nvoid Database::read() {\n  std::cout << file_ << ": in read" << std::endl;\n}\n\nvoid Database::update() {\n  std::cout << file_ << ": in update" << std::endl;\n}\n\nvoid Database::del() {\n  std::cout << file_ << ": in delete" << std::endl;\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:'The source file implements the Database methods. In this case, all they\ndo is make print statements for simplicity. We include "database_lib.h"\nin order to find the Database class we\'re implementing.'}),"\n",(0,r.jsx)(n.h2,{id:"grocery-database-source",children:"Grocery Database Source"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:'#include "database_lib.h"\n\nint main() {\n  Database db("grocery");\n  db.create();\n  db.read();\n  db.update();\n  db.del();\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:'Here we create the grocery database by creating the Database class\nlocated in "database_lib.h".'}),"\n",(0,r.jsx)(n.h2,{id:"movies-database-source",children:"Movies Database Source"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:'#include "database_lib.h"\n\nint main() {\n  Database db("movies");\n  db.create();\n  db.read();\n  db.update();\n  db.del();\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:'Here we create the movies database by creating the Database class\nlocated in "database_lib.h".'}),"\n",(0,r.jsx)(n.h2,{id:"c-compiler-pipeline",children:"C++ Compiler Pipeline"}),"\n",(0,r.jsx)(n.p,{children:"C/C++ compilers are divided into 4 phases:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Preprocessing"}),": This will locate and load #include files and make simple\nmodifications to source code"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Compiling"}),": Will turn the pre-processed source code into assembly code."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Assembling"}),": Will convert assembly code into machine code\n(i.e., object code)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Linking"}),": Will locate shared libraries and ensure that any missing symbols\nare resolved in the object code."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"the-build-directory",children:"The Build Directory"}),"\n",(0,r.jsx)(n.p,{children:"First, we should make a build directory to store our files. This\nmakes cleaning up intermediate files much easier."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"mkdir build\n"})}),"\n",(0,r.jsx)(n.h2,{id:"compile--assemble-database_libcc",children:"Compile + Assemble database_lib.cc"}),"\n",(0,r.jsx)(n.p,{children:"We first try to compile the database into an object file below"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"g++ src/database_lib.cc -fpic -c -o build/database_lib.o\n"})}),"\n",(0,r.jsx)(n.p,{children:"-fPIC stands for Force Poisition Independent Code. Whenever trying to\nbuild a shared object, this is necessary. This is because a shared library\ncan be loaded at different locations in a program, so having the addresses\nin the code being fixed is problematic."}),"\n",(0,r.jsx)(n.p,{children:"-c tells g++ to build the object file."}),"\n",(0,r.jsx)(n.p,{children:"-o database_lib/database_lib.o sets the output of the\ncompilation to be database_lib/database_lib.o."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"You should receive the following error"}),":\n",(0,r.jsxs)("pre",{children:[(0,r.jsx)("b",{children:"src/database_lib.cc:2:10:"})," ",(0,r.jsx)("font",{color:"#EF2929",children:(0,r.jsx)("b",{children:"fatal error: "})}),"database_lib.h: No such file or directory\n2 | #include ",(0,r.jsx)("font",{color:"#EF2929",children:(0,r.jsx)("b",{children:'"database_lib.h"'})}),"\n|          ",(0,r.jsx)("font",{color:"#EF2929",children:(0,r.jsx)("b",{children:"^~~~~~~~~~~~~~~~"})}),"\ncompilation terminated."]})]}),"\n",(0,r.jsx)(n.p,{children:"This is because the compiler doesn't know to look in the include directory\nfor the database_lib.h file. In order to force the compiler to search for\nthis file there are two options."}),"\n",(0,r.jsx)(n.h3,{id:"fix-1-the--i-flag",children:"Fix 1: The -I flag"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"g++ src/database_lib.cc -I${PWD}/include -fpic -c -o build/database_lib.o\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"-I${PWD}/include"})," will ensure the compiler searches the include directory\nfor headers"]}),"\n",(0,r.jsx)(n.h3,{id:"fix-2-environment-variables",children:"Fix 2: Environment Variables"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"INCLUDE=${PWD}/include \\\nCPATH=${PWD}/include \\\ng++ src/database_lib.cc -fpic -c -o build/database_lib.o\n"})}),"\n",(0,r.jsx)(n.p,{children:"INCLUDE and CPATH are sometimes searched by the compiler for header files.\nThis approach is also viable because you don't need to modify build scripts in\norder for it to work."}),"\n",(0,r.jsx)(n.h2,{id:"link-database_libo",children:"Link database_lib.o"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"g++ -shared build/database_lib.o -o build/libdatabase_lib.so\n"})}),"\n",(0,r.jsx)(n.p,{children:'This command will produce the shared library. Note, the general naming\nconvention of a shared object is "libNAME.so". Many compilers expect\nyour shared object to begin with the word "lib" and have an "so"\nextension.'}),"\n",(0,r.jsx)(n.h2,{id:"create-the-executables",children:"Create the Executables"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"g++ src/grocery_db.cc -I${PWD}/include -ldatabase_lib -o grocery_db\ng++ src/movies_db.cc -I${PWD}/include -ldatabase_lib -o movies_db\n"})}),"\n",(0,r.jsx)(n.p,{children:"-ldatabase_lib tells the compiler to search for libdatabase_lib.so"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"You should receive the following error"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"/usr/bin/ld: cannot find -ldatabase_lib\ncollect2: error: ld returned 1 exit status\n"})}),"\n",(0,r.jsx)(n.p,{children:"This is because the compiler doesn't know where to search for libdatabase_lib.so.\nWe have to tell it to search the build directory. There are two fixes."}),"\n",(0,r.jsx)(n.h3,{id:"fix-1-the--l-flag",children:"Fix 1: The -L flag"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"g++ src/grocery_db.cc -I${PWD}/include -L${PWD}/build -ldatabase_lib -o build/grocery_db\ng++ src/movies_db.cc -I${PWD}/include -L${PWD}/build -ldatabase_lib -o build/movies_db\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"-L${PWD}/build"})," tells the compiler to search this directory for shared objects."]}),"\n",(0,r.jsx)(n.h3,{id:"fix-2-environment-variables-1",children:"Fix 2: Environment Variables"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"export LIBRARY_PATH=${PWD}/build\ng++ src/grocery_db.cc -I${PWD}/include -ldatabase_lib -o build/grocery_db\ng++ src/movies_db.cc -I${PWD}/include -ldatabase_lib -o build/movies_db\n"})}),"\n",(0,r.jsx)(n.h2,{id:"run-the-executable",children:"Run the Executable"})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},26543:(e,n,a)=>{a.d(n,{Ay:()=>c,RM:()=>l});var i=a(74848),r=a(28453),t=a(65537),s=a(79329);const l=[];function o(e){const n={admonition:"admonition",code:"code",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,i.jsxs)(t.A,{children:[(0,i.jsxs)(s.A,{value:"docker",label:"Docker",default:!0,children:[(0,i.jsx)(n.p,{children:"You can get the iowarp container to reduce dependency install times:"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"git clone https://github.com/iowarp/iowarp-install.git\ndocker pull iowarp/iowarp-user:latest\ncd iowarp-install/docker/user\ndocker compose up -d  # Only for recent dockers\ndocker-compose up -d  # Only for older dockers\n"})}),(0,i.jsx)(n.p,{children:"To connect to the container:"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker exec -it iowarp bash\n"})}),(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"Docker does not save state. So when you clone the GRC tutorial\nin this container and close the container, the data will be lost."})})]}),(0,i.jsx)(s.A,{value:"linux",label:"Linux",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"git clone https://github.com/grc-iit/grc-tutorial.git\n"})})})]})}function c(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},79329:(e,n,a)=>{a.d(n,{A:()=>s});a(96540);var i=a(34164);const r={tabItem:"tabItem_Ymn6"};var t=a(74848);function s(e){let{children:n,hidden:a,className:s}=e;return(0,t.jsx)("div",{role:"tabpanel",className:(0,i.A)(r.tabItem,s),hidden:a,children:n})}},65537:(e,n,a)=>{a.d(n,{A:()=>_});var i=a(96540),r=a(34164),t=a(65627),s=a(56347),l=a(50372),o=a(30604),c=a(11861),d=a(78749);function u(e){return i.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,i.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:n,children:a}=e;return(0,i.useMemo)((()=>{const e=n??function(e){return u(e).map((e=>{let{props:{value:n,label:a,attributes:i,default:r}}=e;return{value:n,label:a,attributes:i,default:r}}))}(a);return function(e){const n=(0,c.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,a])}function b(e){let{value:n,tabValues:a}=e;return a.some((e=>e.value===n))}function p(e){let{queryString:n=!1,groupId:a}=e;const r=(0,s.W6)(),t=function(e){let{queryString:n=!1,groupId:a}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!a)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return a??null}({queryString:n,groupId:a});return[(0,o.aZ)(t),(0,i.useCallback)((e=>{if(!t)return;const n=new URLSearchParams(r.location.search);n.set(t,e),r.replace({...r.location,search:n.toString()})}),[t,r])]}function m(e){const{defaultValue:n,queryString:a=!1,groupId:r}=e,t=h(e),[s,o]=(0,i.useState)((()=>function(e){let{defaultValue:n,tabValues:a}=e;if(0===a.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!b({value:n,tabValues:a}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${a.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const i=a.find((e=>e.default))??a[0];if(!i)throw new Error("Unexpected error: 0 tabValues");return i.value}({defaultValue:n,tabValues:t}))),[c,u]=p({queryString:a,groupId:r}),[m,x]=function(e){let{groupId:n}=e;const a=function(e){return e?`docusaurus.tab.${e}`:null}(n),[r,t]=(0,d.Dv)(a);return[r,(0,i.useCallback)((e=>{a&&t.set(e)}),[a,t])]}({groupId:r}),f=(()=>{const e=c??m;return b({value:e,tabValues:t})?e:null})();(0,l.A)((()=>{f&&o(f)}),[f]);return{selectedValue:s,selectValue:(0,i.useCallback)((e=>{if(!b({value:e,tabValues:t}))throw new Error(`Can't select invalid tab value=${e}`);o(e),u(e),x(e)}),[u,x,t]),tabValues:t}}var x=a(9136);const f={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var g=a(74848);function j(e){let{className:n,block:a,selectedValue:i,selectValue:s,tabValues:l}=e;const o=[],{blockElementScrollPositionUntilNextRender:c}=(0,t.a_)(),d=e=>{const n=e.currentTarget,a=o.indexOf(n),r=l[a].value;r!==i&&(c(n),s(r))},u=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const a=o.indexOf(e.currentTarget)+1;n=o[a]??o[0];break}case"ArrowLeft":{const a=o.indexOf(e.currentTarget)-1;n=o[a]??o[o.length-1];break}}n?.focus()};return(0,g.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.A)("tabs",{"tabs--block":a},n),children:l.map((e=>{let{value:n,label:a,attributes:t}=e;return(0,g.jsx)("li",{role:"tab",tabIndex:i===n?0:-1,"aria-selected":i===n,ref:e=>{o.push(e)},onKeyDown:u,onClick:d,...t,className:(0,r.A)("tabs__item",f.tabItem,t?.className,{"tabs__item--active":i===n}),children:a??n},n)}))})}function v(e){let{lazy:n,children:a,selectedValue:t}=e;const s=(Array.isArray(a)?a:[a]).filter(Boolean);if(n){const e=s.find((e=>e.props.value===t));return e?(0,i.cloneElement)(e,{className:(0,r.A)("margin-top--md",e.props.className)}):null}return(0,g.jsx)("div",{className:"margin-top--md",children:s.map(((e,n)=>(0,i.cloneElement)(e,{key:n,hidden:e.props.value!==t})))})}function y(e){const n=m(e);return(0,g.jsxs)("div",{className:(0,r.A)("tabs-container",f.tabList),children:[(0,g.jsx)(j,{...n,...e}),(0,g.jsx)(v,{...n,...e})]})}function _(e){const n=(0,x.A)();return(0,g.jsx)(y,{...e,children:u(e.children)},String(n))}},28453:(e,n,a)=>{a.d(n,{R:()=>s,x:()=>l});var i=a(96540);const r={},t=i.createContext(r);function s(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);